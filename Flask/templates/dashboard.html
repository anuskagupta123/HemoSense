{% extends "base.html" %}
{% block title %}Dashboard â€“ HemoSense{% endblock %}

{% block content %}
<div class="dashboard-wrapper">

  <!-- SIDEBAR -->
  <aside class="sidebar glass">
    <div class="side-brand">
      <div class="logo small-logo">Hb</div>
      <h3>HemoSense</h3>
      <p class="muted">AI Health Assistant</p>
    </div>

    <ul class="side-menu">
      <li><a href="{{ url_for('dashboard') }}" class="active">ğŸ  Dashboard</a></li>
      <li><a href="{{ url_for('predict') }}">ğŸ” New Prediction</a></li>
      <li><a href="{{ url_for('profile') }}">ğŸ‘¤ Profile</a></li>
      <li><a href="{{ url_for('change_password') }}">ğŸ”‘ Change Password</a></li>
      <li><a href="{{ url_for('logout') }}" class="logout">ğŸšª Logout</a></li>
    </ul>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="dash-main">

    <div class="welcome-box glass animate-fade">
      <h2>Welcome back, {{ user_name }} ğŸ‘‹</h2>
      <p>Your personalized anemia insights and predictions are below.</p>
    </div>

    <!-- METRICS GRID -->
    <div class="metric-grid">

      <div class="metric-card glass animate-scale">
        <div class="metric-icon">ğŸ“Š</div>
        <div class="metric-title">Total Predictions</div>
        <div class="metric-value">{{ total_predictions }}</div>
      </div>

      <div class="metric-card glass animate-scale">
        <div class="metric-icon">ğŸ©¸</div>
        <div class="metric-title">Last Result</div>
        <div class="metric-value">
          {% if recent_predictions %} 
            {{ recent_predictions[-1].category }} 
          {% else %} â€” {% endif %}
        </div>
      </div>

      <div class="metric-card glass animate-scale">
        <div class="metric-icon">âš¡</div>
        <div class="metric-title">Quick Action</div>
        <a href="{{ url_for('predict') }}" class="btn primary full">Run Prediction</a>
      </div>

    </div>

    <!-- CHARTS -->
    <div class="chart-section">
      <div class="chart-card glass">
        <h4>Normal vs Anemia</h4>
        <canvas id="categoryChart"></canvas>
      </div>

      <div class="chart-card glass">
        <h4>Hemoglobin Ranges</h4>
        <canvas id="hbChart"></canvas>
      </div>
    </div>

    <!-- HISTORY TABLE -->
    <div class="history-card glass">
      <h4>Recent Predictions</h4>

      {% if recent_predictions %}
      <table class="table">
        <thead>
          <tr>
            <th>Age</th><th>Gender</th><th>Hb</th><th>Category</th><th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for p in recent_predictions %}
          <tr>
            <td>{{ p.age }}</td>
            <td>{{ p.gender }}</td>
            <td>{{ p.hb }}</td>
            <td>{{ p.category }}</td>
            <td>{{ p.timestamp.strftime("%Y-%m-%d %H:%M") }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="muted">No predictions yet.</p>
      {% endif %}
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const categoryCounts = JSON.parse(`{{ category_counts | tojson | safe }}`);
  const hbRanges = JSON.parse(`{{ hb_ranges | tojson | safe }}`);

  new Chart(document.getElementById("categoryChart"), {
    type: "doughnut",
    data: {
      labels: ["Normal", "Anemia"],
      datasets: [{
        data: [categoryCounts.Normal || 0, categoryCounts.Anemia || 0],
        backgroundColor:["#34d399", "#ef4444"]
      }]
    },
    options:{ plugins:{ legend:{ position:"bottom" } } }
  });

  new Chart(document.getElementById("hbChart"), {
  type:"bar",
  data:{
    labels:["<7","7â€“9.9","10â€“12",">12"],
    datasets:[{
      label: "Hb Count",     // â­ ADD THIS LINE
      data:[
        hbRanges["<7"]||0, hbRanges["7-9.9"]||0,
        hbRanges["10-12"]||0, hbRanges[">12"]||0
      ],
      backgroundColor:"#2563eb",
      borderRadius:8
    }]
  },
  options:{ 
    scales:{ 
      y:{ beginAtZero:true } 
    } 
  }
});

</script>

{% endblock %}
